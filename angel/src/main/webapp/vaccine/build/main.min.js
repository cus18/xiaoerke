var app=angular.module("app",["ui.router","ngCookies","ngGrid"]);var SERVER_BASE_URL="http://123.57.45.33:8088/";app.run(["$rootScope",function(A){A.appName="图班网";A.desc="后台管理";A.author="鬼谣";A.email="wlhmyit@126.com"}]);app.constant("ServiceConfig",{user_login:SERVER_BASE_URL+"user/login",user_getAll:SERVER_BASE_URL+"user/getAll",user_updateTag:SERVER_BASE_URL+"user/updateTag",user_getUserByCondition:SERVER_BASE_URL+"user/getByCondition",user_delete:SERVER_BASE_URL+"user/delete",article_create:SERVER_BASE_URL+"article/create",weibo_getByCondition:SERVER_BASE_URL+"wei/getByCondition",weibo_set2null:SERVER_BASE_URL+"wei/set2null",email_findPassword:SERVER_BASE_URL+"email/findPassword",vaccine_getVaccineStation:SERVER_BASE_URL+"vaccine/getVaccineStation",vaccine_saveBabyVaccine:SERVER_BASE_URL+"vaccine/saveBabyVaccine"});app.config(["$httpProvider",function(A){A.defaults.headers.post["Content-Type"]="application/x-www-form-urlencoded;charset=utf-8";A.defaults.headers.put["Content-Type"]="application/x-www-form-urlencoded;charset=utf-8";A.defaults.transformRequest=[function(D){var C=[];for(var B in D){C.push(B+"="+D[B])}return C.join("&")}]}]);app.config(["$stateProvider","$urlRouterProvider",function(A,B){B.otherwise("/");A.state("login",{url:"/login",views:{"":{templateUrl:"views/login.html",controller:"LoginController"}}}).state("index",{url:"/index",views:{"":{templateUrl:"views/index.html",controller:"MenuController"}}}).state("vaccineIndex",{url:"/:openId,:QRCode",views:{"":{templateUrl:"views/vaccineIndex.html",controller:"VaccineIndexController"}}}).state("index.article",{url:"/article",views:{"":{templateUrl:"views/index.html",controller:"MenuController"},"list@index":{templateUrl:"views/article.html",controller:"ArticleController"}}}).state("index.weibo",{url:"/weibo",views:{"":{templateUrl:"views/index.html",controller:"MenuController"},"list@index":{templateUrl:"views/weibo.html",controller:"WeiboController"}}}).state("index.user",{url:"/user",views:{"":{templateUrl:"views/index.html",controller:"MenuController"},"list@index":{templateUrl:"views/user.html",controller:"UserController"}}}).state("index.email",{url:"/email",views:{"":{templateUrl:"views/index.html",controller:"MenuController"},"list@index":{templateUrl:"views/email.html",controller:"EmailController"}}})}]);app.service("MenuSelect",["$rootScope",function(A){return{setSelected:function(B){A.select_user="menu_unselect";A.select_article="menu_unselect";A.select_weibo="menu_unselect";A.select_email="menu_unselect";A.select_login="menu_unselect";if(B){A[B]="menu_select"}}}}]);app.controller("LoginController",["$scope","$http","$rootScope","$cookieStore","$timeout","$location","ServiceConfig",function(D,F,A,B,E,C,G){D.login=function(){var I=D.email,H=D.password,J={"email":I,"password":H};F.post(G.user_login,J).success(function(L){if(L.status){B.put("user",L);C.path("/index/user")}else{var K=window.innerWidth;Tip.setTip(250,(parseInt(K)-240)/2,null,null,260,80,"难倒你忘记了密码...",1);E(Tip.hideTip,3000)}}).error(function(){var K=window.innerWidth;Tip.setTip(250,(parseInt(K)-240)/2,null,null,260,80,"服务君该回家养老了...",1);E(Tip.hideTip,3000)})};D.goRegister=function(){C.path("/register")}}]);app.controller("ArticleController",["$scope","$rootScope","$timeout","$http","$cookieStore","ServiceConfig","MenuSelect",function(A,H,G,E,D,I,C){var B=D.get("user");var F=window.innerWidth;C.setSelected("select_article");A.author="";A.submit=function(M,N,J,O,K){var L={token:B.token,title:M||"",author:N||"",link:J||"",ref:O||"",content:K||[]};E.post(I.article_create,L).success(function(P){if(P.status){A.author="";A.title="";A.author="";A.ref="";A.link="";A.content="";Tip.setTip(250,(parseInt(F)-240)/2,null,null,260,80,"文章发表成功....",1);G(Tip.hideTip,3000)}else{Tip.setTip(250,(parseInt(F)-240)/2,null,null,260,80,"文章发表失败....",1);G(Tip.hideTip,3000)}})}}]);app.controller("MenuController",["$rootScope","$location",function(A,B){var C=B.path();switch(C){case"/index/user":A.select_user="menu_select";break;case"/index/article":A.select_article="menu_select";break;case"/index/weibo":A.select_weibo="menu_select";break;case"/index/qita":A.select_qita="menu_select";break;case"/index/login":A.select_login="menu_select";break;default:break}}]);app.controller("UserController",["$scope","$rootScope","$timeout","$http","$cookieStore","ServiceConfig","MenuSelect",function(A,H,G,E,D,I,C){var B=D.get("user");var F=window.innerWidth;C.setSelected("select_user");A.mySelections=[];A.filterOptions={filterText:"",useExternalFilter:true};A.totalServerItems=0;A.pagingOptions={pageSizes:[10,15,30],pageSize:10,currentPage:1};A.setPagingData=function(M,K,J){var L=M.slice((K-1)*J,K*J);A.myData=L;A.totalServerItems=M.length;if(!A.$$phase){A.$apply()}};A.getPagedDataAsync=function(J,K){setTimeout(function(){E.get(I.user_getAll+"?token="+B.token).success(function(L){if(L.status){A.setPagingData(L.items,K,J)}})},100)};A.getPagedDataAsync(A.pagingOptions.pageSize,A.pagingOptions.currentPage);A.$watch("pagingOptions",function(K,J){if(K!==J&&K.currentPage!==J.currentPage){A.getPagedDataAsync(A.pagingOptions.pageSize,A.pagingOptions.currentPage)}},true);A.$on("ngGridEventEndCellEdit",function(K){var J=K.targetScope.row.entity;var L={userid:J.userid,token:B.token,tag:J.tag};E.post(I.user_updateTag,L).success(function(M){if(!M.status){Tip.setTip(250,(parseInt(F)-240)/2,null,null,260,80,"数据更新失败",1);G(Tip.hideTip,3000)}})});A.removeRow=function(K){var J={token:B.token,userid:K.userid};console.log(I.user_delete);E.post(I.user_delete,J).success(function(L){if(L.status){Tip.setTip(250,(parseInt(F)-240)/2,null,null,260,80,"删除成功......",1);G(Tip.hideTip,3000)}else{Tip.setTip(250,(parseInt(F)-240)/2,null,null,260,80,"删除失败......",1);G(Tip.hideTip,3000)}})};A.gridOptions={data:"myData",enablePaging:true,showFooter:true,enableCellEdit:true,totalServerItems:"totalServerItems",pagingOptions:A.pagingOptions,multiSelect:false,selectedItems:A.mySelections,columnDefs:[{field:"userid",displayName:"用户ID"},{field:"email",displayName:"邮箱"},{field:"tag",displayName:"角色"},{field:"nickname",displayName:"昵称"},{field:"realname",displayName:"真实姓名"},{field:"tel",displayName:"电话"},{field:"慎重操作",cellTemplate:'<button class="user_btn" ng-click="removeRow(row.entity)">删除</button>'}]};A.Search=function(J,L,K){if(J.keyCode===13||J.which===32){var M="?token="+B.token+"&";var L=L||"default";switch(L){case"email":M=M+"email="+K;break;case"nickname":M=M+"nickname="+K;break;case"realname":M=M+"realname="+K;break;default:console.log(K);M=M+"email="+K;break}E.get(I.user_getUserByCondition+M).success(function(N){if(N.status){A.mySelections=N.items}else{}})}}}]);app.controller("WeiboController",["$scope","$rootScope","$http","$cookieStore","$timeout","ServiceConfig","MenuSelect",function(A,H,E,D,G,I,C){var B=D.get("user");var F=window.innerWidth;C.setSelected("select_weibo");A.email="";A.search=function(J,L,N,K){var M="";if(J){M="?email="+J}if(L){M="?nickname="+L}if(N){M="?realname="+N}if(K){M="?content="+K}E.get(I.weibo_getByCondition+M).success(function(O){A.weiboObj=JSON.stringify(O)})};A.modify=function(){var J={token:B.token,_id:JSON.parse(A.weiboObj)._id};E.post(I.weibo_set2null,J).success(function(K){if(K.status){Tip.setTip(250,(parseInt(F)-240)/2,null,null,260,80,"微博置空成功....",1);G(Tip.hideTip,3000)}else{Tip.setTip(250,(parseInt(F)-240)/2,null,null,260,80,"微博置空失败....",1);G(Tip.hideTip,3000)}})}}]);app.controller("EmailController",["$scope","$rootScope","$http","$timeout","$cookieStore","ServiceConfig","MenuSelect",function(A,H,E,G,D,I,C){var B=D.get("user");var F=window.innerWidth;C.setSelected("select_email");A.postEmail=function(J){var K={token:B.token,email:J};E.post(I.email_findPassword,K).success(function(L){if(L.status){Tip.setTip(250,(parseInt(F)-240)/2,null,null,260,80,"邮件发送成功....",1);G(Tip.hideTip,3000)}else{Tip.setTip(250,(parseInt(F)-240)/2,null,null,260,80,"邮件发送失败....",1);G(Tip.hideTip,3000)}})}}]);app.controller("VaccineIndexController",["$scope","$http","ServiceConfig","$stateParams",function(C,D,E,B){C.info={babyName:"",babyNum:"",vaccineStation:"请选择>"};C.openId=B.openId;C.QRCode=B.QRCode;C.sexItem="";C.showInput=function(){var G=new Date(+new Date()+8*3600*1000).toISOString().replace(/T/g," ").replace(/\.[\d]{3}Z/,"");$("#babyBirthday").mobiscroll().date();var F={preset:"date",theme:"default",display:"modal",mode:"scroller",lang:"zh",dateFormat:"yyyy-mm-dd",setText:"确定",cancelText:"取消",dateOrder:"yyyymmdd",dayText:"日",monthText:"月",yearText:"年",showNow:false,nowText:"今",startYear:1960,maxDate:new Date(G.substring(0,4),G.substring(5,7)-1,G.substring(8,10))};$("#babyBirthday").mobiscroll(F);$("#babyBirthday").mobiscroll("show")};var A="";D.post(E.vaccine_getVaccineStation,A).success(function(F){C.vaccineStationType=F.vaccineStationInfo;console.log("$scope.vaccineStationType",C.vaccineStationType)}).error(function(){});C.isSelectedG=true;C.isSelectedB=false;C.selectSex=function(F){C.sexItem=F;if(C.sexItem==0){C.isSelectedB=true;C.isSelectedG=false}if(C.sexItem==1){C.isSelectedG=true;C.isSelectedB=false}};$(".select-area .select-value").each(function(){if($(this).next("select").find("option:selected").length!=0){$(this).text($(this).next("select").find("option:selected").text())}});$(".select-area select").change(function(){var F=$(this).find("option:selected").text();$(this).parent(".select-area").find(".select-value").text(F)});C.submit=function(){if(C.info.babyName==""){alert("宝宝姓名不能为空！");return}if(C.sexItem==null){alert("宝宝性别不能为空！");return}if($("#babyBirthday").val()==""){alert("宝宝生日不能为空！");return}if(C.info.babyNum==""){alert("宝宝接种编号不能为空！");return}if(C.info.vaccineStation.vaccineStationName==""){alert("宝宝疫苗站不能为空！");return}var F={"openId":C.openId,"birthday":$("#babyBirthday").val(),"name":C.info.babyName,"sex":C.sexItem,"QRCode":C.QRCode,"babySeedNumber":C.info.babyNum,"vaccineStationId":C.info.vaccineStation.vaccineStationId,"vaccineStationName":C.info.vaccineStation.vaccineStationName};console.log("information",F);D.post(E.vaccine_saveBabyVaccine,F).success(function(G){console.log(G);console.log("information",F)}).error(function(){})}}]);